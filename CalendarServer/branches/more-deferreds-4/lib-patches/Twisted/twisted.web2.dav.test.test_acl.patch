Index: twisted/web2/dav/test/test_acl.py
===================================================================
--- twisted/web2/dav/test/test_acl.py	(revision 26969)
+++ twisted/web2/dav/test/test_acl.py	(working copy)
@@ -26,6 +26,8 @@
 
 from twisted.cred.portal import Portal
 
+from twisted.internet.defer import waitForDeferred, deferredGenerator, succeed
+
 from twisted.web2 import responsecode
 from twisted.web2.auth import basic
 from twisted.web2.stream import MemoryStream
@@ -57,7 +59,7 @@
         if typeResource:
             user = typeResource.children.get(shortName, None)
 
-        return user
+        return succeed(user)
 
 class ACL(twisted.web2.dav.test.util.TestCase):
     """
@@ -68,7 +70,9 @@
         os.mkdir(docroot)
 
         userResource = TestDAVPrincipalResource("/principals/users/user01")
-        userResource.writeDeadProperty(TwistedPasswordProperty("user01"))
+        d = waitForDeferred(userResource.writeDeadProperty(TwistedPasswordProperty("user01")))
+        yield d
+        d = d.getResult()
 
         principalCollection = TestPrincipalsCollection(
             "/principals/",
@@ -93,7 +97,9 @@
             loginInterfaces
         ))
 
-        rootResource.setAccessControlList(self.grant(davxml.All()))
+        d = waitForDeferred(rootResource.setAccessControlList(self.grant(davxml.All())))
+        yield d
+        d.getResult( )
 
         for name, acl in (
             ("none"       , self.grant()),
@@ -118,8 +124,9 @@
                 os.mkdir(dirname)
             resource = self.resource_class(dirname)
             resource.setAccessControlList(acl)
-        return docroot
+        yield docroot
 
+    createDocumentRoot = deferredGenerator(createDocumentRoot)
 
     def restore(self):
         # Get rid of whatever messed up state the test has now so that we'll
@@ -137,6 +144,7 @@
             dst_path = os.path.join(self.docroot, "copy_dst")
             dst_uri = "/" + os.path.basename(dst_path)
 
+            results = []
             for src, status in (
                 ("nobind", responsecode.FORBIDDEN),
                 ("bind",   responsecode.FORBIDDEN),
@@ -147,11 +155,15 @@
                 if not os.path.isdir(src_path):
                     os.mkdir(src_path)
                 src_resource = self.resource_class(src_path)
-                src_resource.setAccessControlList({
+
+                d = waitForDeferred(src_resource.setAccessControlList({
                     "nobind": self.grant(),
                     "bind"  : self.grant(davxml.Bind()),
                     "unbind": self.grant(davxml.Bind(), davxml.Unbind())
-                }[src])
+                }[src]))
+                yield d
+                d.getResult()
+
                 for name, acl in (
                     ("none"       , self.grant()),
                     ("read"       , self.grant(davxml.Read())),
@@ -162,8 +174,11 @@
                     filename = os.path.join(src_path, name)
                     if not os.path.isfile(filename):
                         file(filename, "w").close()
-                    self.resource_class(filename).setAccessControlList(acl)
 
+                    d = waitForDeferred(self.resource_class(filename).setAccessControlList(acl))
+                    yield d
+                    d.getResult()
+
                 for method in ("COPY", "MOVE"):
                     for name, code in (
                         ("none"       , {"COPY": responsecode.FORBIDDEN, "MOVE": status}[method]),
@@ -184,12 +199,30 @@
                                 os.remove(dst_path)
     
                             if response.code != code:
-                                return self.oops(request, response, code, method, name)
+                                d = waitForDeferred(self.oops(request, response, code, method, name))
+                                yield d
+                                d = d.getResult()
+                                yield d
+                                return
     
-                        yield (request, test)
+                        results.append( (request, test) )
 
-        return serialize(self.send, work())
+            yield results
 
+        work = deferredGenerator(work)
+
+        d = waitForDeferred(work())
+        yield d
+        results = d.getResult()
+
+        d = waitForDeferred(serialize(self.send, iter(results)))
+        yield d
+        d = d.getResult()
+        yield d
+
+    test_COPY_MOVE_source = deferredGenerator(test_COPY_MOVE_source)
+
+
     def test_COPY_MOVE_dest(self):
         """
         Verify destination access controls during COPY and MOVE.
@@ -198,6 +231,7 @@
             src_path = os.path.join(self.docroot, "read")
             uri = "/" + os.path.basename(src_path)
 
+            results = []
             for method in ("COPY", "MOVE"):
                 for name, code in (
                     ("nobind" , responsecode.FORBIDDEN),
@@ -216,18 +250,41 @@
                             os.remove(dst_path)
 
                         if response.code != code:
-                            return self.oops(request, response, code, method, name)
+                            d = waitForDeferred(self.oops(request, response, code, method, name))
+                            yield d
+                            d = d.getResult()
+                            yield d
+                            return
 
-                    yield (request, test)
+                    results.append((request, test))
                     self.restore()
+                    # restore( ) blows away _docroot explicitly;
+                    # need to repopulate it
+                    d = waitForDeferred(self._getDocumentRoot())
+                    yield d
+                    d.getResult()
 
-        return serialize(self.send, work())
+            yield results
 
+        work = deferredGenerator(work)
+
+        d = waitForDeferred(work())
+        yield d
+        results = d.getResult()
+
+        d = waitForDeferred(serialize(self.send, iter(results)))
+        yield d
+        d = d.getResult()
+        yield d
+
+    test_COPY_MOVE_dest = deferredGenerator(test_COPY_MOVE_dest)
+
     def test_DELETE(self):
         """
         Verify access controls during DELETE.
         """
         def work():
+            results = []
             for name, code in (
                 ("nobind" , responsecode.FORBIDDEN),
                 ("bind"   , responsecode.FORBIDDEN),
@@ -243,12 +300,28 @@
 
                 def test(response, code=code, path=path):
                     if response.code != code:
-                        return self.oops(request, response, code, "DELETE", name)
+                        d = waitForDeferred(self.oops(request, response, code, "DELETE", name))
+                        yield d
+                        d = d.getResult()
+                        yield d
+                        return
 
-                yield (request, test)
+                results.append((request, test))
 
-        return serialize(self.send, work())
+            yield results
 
+        work = deferredGenerator(work)
+
+        d = waitForDeferred(work())
+        yield d
+        results = d.getResult()
+
+        d = waitForDeferred(serialize(self.send, iter(results)))
+        yield d
+        d = d.getResult()
+        yield d
+
+
     def test_UNLOCK(self):
         """
         Verify access controls during UNLOCK of unowned lock.
@@ -261,8 +334,10 @@
         """
         Verify access controls during MKCOL.
         """
-        for method in ("MKCOL", "PUT"):
-            def work():
+        def work():
+            results = []
+
+            for method in ("MKCOL", "PUT"):
                 for name, code in (
                     ("nobind" , responsecode.FORBIDDEN),
                     ("bind"   , responsecode.CREATED),
@@ -281,17 +356,34 @@
 
                     def test(response, code=code, path=path):
                         if response.code != code:
-                            return self.oops(request, response, code, method, name)
+                            d = waitForDeferred(self.oops(request, response, code, "DELETE", name))
+                            yield d
+                            d = d.getResult()
+                            yield d
+                            return
 
-                    yield (request, test)
+                    results.append((request, test))
 
-        return serialize(self.send, work())
+            yield results
 
+        work = deferredGenerator(work)
+
+        d = waitForDeferred(work())
+        yield d
+        results = d.getResult()
+
+        d = waitForDeferred(serialize(self.send, iter(results)))
+        yield d
+        d = d.getResult()
+        yield d
+
+
     def test_PUT_exists(self):
         """
         Verify access controls during PUT of existing file.
         """
         def work():
+            results = []
             for name, code in (
                 ("none"       , responsecode.FORBIDDEN),
                 ("read"       , responsecode.FORBIDDEN),
@@ -306,12 +398,28 @@
 
                 def test(response, code=code, path=path):
                     if response.code != code:
-                        return self.oops(request, response, code, "PUT", name)
+                        d = waitForDeferred(self.oops(request, response, code, "PUT", name))
+                        yield d
+                        d = d.getResult()
+                        yield d
+                        return
 
-                yield (request, test)
+                results.append((request, test))
 
-        return serialize(self.send, work())
+            yield results
 
+        work = deferredGenerator(work)
+
+        d = waitForDeferred(work())
+        yield d
+        results = d.getResult()
+
+        d = waitForDeferred(serialize(self.send, iter(results)))
+        yield d
+        d = d.getResult()
+        yield d
+
+
     def test_PROPFIND(self):
         """
         Verify access controls during PROPFIND.
@@ -325,6 +433,7 @@
         Verify access controls during PROPPATCH.
         """
         def work():
+            results = []
             for name, code in (
                 ("none"       , responsecode.FORBIDDEN),
                 ("read"       , responsecode.FORBIDDEN),
@@ -342,17 +451,33 @@
 
                 def test(response, code=code, path=path):
                     if response.code != code:
-                        return self.oops(request, response, code, "PROPPATCH", name)
+                        d = waitForDeferred(self.oops(request, response, code, "PROPPATCH", name))
+                        yield d
+                        d = d.getResult()
+                        yield d
+                        return
 
-                yield (request, test)
+                results.append((request, test))
 
-        return serialize(self.send, work())
+            yield results
 
+        work = deferredGenerator(work)
+
+        d = waitForDeferred(work())
+        yield d
+        results = d.getResult()
+
+        d = waitForDeferred(serialize(self.send, iter(results)))
+        yield d
+        d = d.getResult()
+        yield d
+
     def test_GET_REPORT(self):
         """
         Verify access controls during GET and REPORT.
         """
         def work():
+            results = []
             for method in ("GET", "REPORT"):
                 if method == "GET":
                     ok = responsecode.OK
@@ -378,12 +503,27 @@
 
                     def test(response, code=code, path=path):
                         if response.code != code:
-                            return self.oops(request, response, code, method, name)
+                            d = waitForDeferred(self.oops(request, response, code, method, name))
+                            yield d
+                            d = d.getResult()
+                            yield d
 
-                    yield (request, test)
+                    results.append((request, test))
 
-        return serialize(self.send, work())
+            yield results
 
+        work = deferredGenerator(work)
+
+        d = waitForDeferred(work())
+        yield d
+        results = d.getResult()
+
+        d = waitForDeferred(serialize(self.send, iter(results)))
+        yield d
+        d = d.getResult()
+        yield d
+
+
     def oops(self, request, response, code, method, name):
         def gotResponseData(doc):
             if doc is None:

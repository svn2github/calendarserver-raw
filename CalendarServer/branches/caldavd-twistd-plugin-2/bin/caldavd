#!/bin/sh

##
# Copyright (c) 2005-2006 Apple Computer, Inc. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# DRI: David Reid, dreid@apple.com
##

daemonize="";
username="";
groupname="";
configfile="";
twistdpath="$(type -p twistd)";

python="$(type -p python2.5)";

if [ "$?" != "0" ]; then
    python="$(type -p python2.4)";
fi;

usage ()
{
    program="$(basename "$0")";
    
    if [ "${1--}" != "-" ]; then echo "${1}"; echo; fi;

    echo "Usage: ${program} [-hX] [-u username] [-g groupname] [-T twistd] [-f caldavd.plist]";
    echo "Options:";
    echo "        -h Print this help and exit";
    echo "        -X Do not daemonize";
    echo "        -u Username to run as";
    echo "        -g Group to run as";
    echo "        -f Configuration file to read";
    echo "        -T Path to twistd binary";
    
    if [ "${1-}" == "-" ]; then return 0; fi;
    exit 64;
}

while getopts 'hXu:g:f:T:' option; do
    case "${option}" in
        '?') usage; ;;
        'h') usage -; exit 0; ;;
        'X') daemonize='-n'; ;;
        'f') configfile="-f ${OPTARG}"; ;;
        'T') twistdpath="${OPTARG}"; ;;
        'u') username="-u ${OPTARG}"; ;;
        'g') grouname="-g ${OPTARG}"; ;;
    esac;
done;

shift $((${OPTIND} - 1));

if [ $# != 0 ]; then usage "Unrecognized arguments:" "$@"; fi;

exec "${python}" "${twistdpath}" \
    "${daemonize}" ${username} ${groupname} caldav ${configfile};


Index: twisted/web2/test/test_httpauth.py
===================================================================
--- twisted/web2/test/test_httpauth.py	(revision 26342)
+++ twisted/web2/test/test_httpauth.py	(working copy)
@@ -3,6 +3,7 @@
 
 from twisted.python.hashlib import md5
 from twisted.internet import address
+from twisted.internet.defer import inlineCallbacks
 from twisted.trial import unittest
 from twisted.cred import error
 from twisted.web2 import http, responsecode
@@ -44,22 +45,25 @@
         self.username = 'dreid'
         self.password = 'S3CuR1Ty'
 
+    @inlineCallbacks
     def testUsernamePassword(self):
         response = base64.encodestring('%s:%s' % (
                 self.username,
                 self.password))
 
-        creds = self.credentialFactory.decode(response, _trivial_GET)
+        creds = (yield self.credentialFactory.decode(response, _trivial_GET))
         self.failUnless(creds.checkPassword(self.password))
 
+    @inlineCallbacks
     def testIncorrectPassword(self):
         response = base64.encodestring('%s:%s' % (
                 self.username,
                 'incorrectPassword'))
 
-        creds = self.credentialFactory.decode(response, _trivial_GET)
+        creds = (yield self.credentialFactory.decode(response, _trivial_GET))
         self.failIf(creds.checkPassword(self.password))
 
+    @inlineCallbacks
     def testIncorrectPadding(self):
         response = base64.encodestring('%s:%s' % (
                 self.username,
@@ -67,7 +71,7 @@
 
         response = response.strip('=')
 
-        creds = self.credentialFactory.decode(response, _trivial_GET)
+        creds = (yield self.credentialFactory.decode(response, _trivial_GET))
         self.failUnless(creds.checkPassword(self.password))
 
     def testInvalidCredentials(self):
@@ -138,6 +142,7 @@
             )
         return expected
 
+    @inlineCallbacks
     def test_getChallenge(self):
         """
         Test that all the required fields exist in the challenge,
@@ -145,42 +150,44 @@
         DigestCredentialFactory
         """
 
-        challenge = self.credentialFactory.getChallenge(clientAddress)
+        challenge = (yield self.credentialFactory.getChallenge(clientAddress))
         self.assertEquals(challenge['qop'], 'auth')
         self.assertEquals(challenge['realm'], 'test realm')
         self.assertEquals(challenge['algorithm'], 'md5')
         self.assertTrue(challenge.has_key("nonce"))
         self.assertTrue(challenge.has_key("opaque"))
 
+    @inlineCallbacks
     def test_response(self):
         """
         Test that we can decode a valid response to our challenge
         """
 
-        challenge = self.credentialFactory.getChallenge(clientAddress)
+        challenge = (yield self.credentialFactory.getChallenge(clientAddress))
 
         clientResponse = authRequest1 % (
             challenge['nonce'],
             self.getDigestResponse(challenge, "00000001"),
             challenge['opaque'])
 
-        creds = self.credentialFactory.decode(clientResponse, _trivial_GET)
+        creds = (yield self.credentialFactory.decode(clientResponse, _trivial_GET))
         self.failUnless(creds.checkPassword('password'))
 
+    @inlineCallbacks
     def test_multiResponse(self):
         """
         Test that multiple responses to to a single challenge are handled
         successfully.
         """
 
-        challenge = self.credentialFactory.getChallenge(clientAddress)
+        challenge = (yield self.credentialFactory.getChallenge(clientAddress))
 
         clientResponse = authRequest1 % (
             challenge['nonce'],
             self.getDigestResponse(challenge, "00000001"),
             challenge['opaque'])
 
-        creds = self.credentialFactory.decode(clientResponse, _trivial_GET)
+        creds = (yield self.credentialFactory.decode(clientResponse, _trivial_GET))
         self.failUnless(creds.checkPassword('password'))
 
         clientResponse = authRequest2 % (
@@ -188,24 +195,25 @@
             self.getDigestResponse(challenge, "00000002"),
             challenge['opaque'])
 
-        creds = self.credentialFactory.decode(clientResponse, _trivial_GET)
+        creds = (yield self.credentialFactory.decode(clientResponse, _trivial_GET))
         self.failUnless(creds.checkPassword('password'))
 
+    @inlineCallbacks
     def test_failsWithDifferentMethod(self):
         """
         Test that the response fails if made for a different request method
         than it is being issued for.
         """
 
-        challenge = self.credentialFactory.getChallenge(clientAddress)
+        challenge = (yield self.credentialFactory.getChallenge(clientAddress))
 
         clientResponse = authRequest1 % (
             challenge['nonce'],
             self.getDigestResponse(challenge, "00000001"),
             challenge['opaque'])
 
-        creds = self.credentialFactory.decode(clientResponse,
-                                              SimpleRequest(None, 'POST', '/'))
+        creds = (yield self.credentialFactory.decode(clientResponse,
+                                              SimpleRequest(None, 'POST', '/')))
         self.failIf(creds.checkPassword('password'))
 
     def test_noUsername(self):
@@ -250,20 +258,21 @@
                               _trivial_GET)
         self.assertEquals(str(e), "Invalid response, no opaque given.")
 
+    @inlineCallbacks
     def test_checkHash(self):
         """
         Check that given a hash of the form 'username:realm:password'
         we can verify the digest challenge
         """
 
-        challenge = self.credentialFactory.getChallenge(clientAddress)
+        challenge = (yield self.credentialFactory.getChallenge(clientAddress))
 
         clientResponse = authRequest1 % (
             challenge['nonce'],
             self.getDigestResponse(challenge, "00000001"),
             challenge['opaque'])
 
-        creds = self.credentialFactory.decode(clientResponse, _trivial_GET)
+        creds = (yield self.credentialFactory.decode(clientResponse, _trivial_GET))
 
         self.failUnless(creds.checkHash(
                 md5('username:test realm:password').hexdigest()))
@@ -271,6 +280,7 @@
         self.failIf(creds.checkHash(
                 md5('username:test realm:bogus').hexdigest()))
 
+    @inlineCallbacks
     def test_invalidOpaque(self):
         """
         Test that login fails when the opaque does not contain all the required
@@ -279,7 +289,7 @@
 
         credentialFactory = FakeDigestCredentialFactory('md5', 'test realm')
 
-        challenge = credentialFactory.getChallenge(clientAddress)
+        challenge = (yield credentialFactory.getChallenge(clientAddress))
 
         self.assertRaises(
             error.LoginFailed,
@@ -305,6 +315,7 @@
             challenge['nonce'],
             clientAddress.host)
 
+    @inlineCallbacks
     def test_incompatibleNonce(self):
         """
         Test that login fails when the given nonce from the response, does not
@@ -313,7 +324,7 @@
 
         credentialFactory = FakeDigestCredentialFactory('md5', 'test realm')
 
-        challenge = credentialFactory.getChallenge(clientAddress)
+        challenge = (yield credentialFactory.getChallenge(clientAddress))
 
         badNonceOpaque = credentialFactory.generateOpaque(
             '1234567890',
@@ -333,6 +344,7 @@
             '',
             clientAddress.host)
 
+    @inlineCallbacks
     def test_incompatibleClientIp(self):
         """
         Test that the login fails when the request comes from a client ip
@@ -341,7 +353,7 @@
 
         credentialFactory = FakeDigestCredentialFactory('md5', 'test realm')
 
-        challenge = credentialFactory.getChallenge(clientAddress)
+        challenge = (yield credentialFactory.getChallenge(clientAddress))
 
         badNonceOpaque = credentialFactory.generateOpaque(
             challenge['nonce'],
@@ -354,6 +366,7 @@
             challenge['nonce'],
             clientAddress.host)
 
+    @inlineCallbacks
     def test_oldNonce(self):
         """
         Test that the login fails when the given opaque is older than
@@ -362,7 +375,7 @@
 
         credentialFactory = FakeDigestCredentialFactory('md5', 'test realm')
 
-        challenge = credentialFactory.getChallenge(clientAddress)
+        challenge = (yield credentialFactory.getChallenge(clientAddress))
 
         key = '%s,%s,%s' % (challenge['nonce'],
                             clientAddress.host,
@@ -379,6 +392,7 @@
             challenge['nonce'],
             clientAddress.host)
 
+    @inlineCallbacks
     def test_mismatchedOpaqueChecksum(self):
         """
         Test that login fails when the opaque checksum fails verification
@@ -386,7 +400,7 @@
 
         credentialFactory = FakeDigestCredentialFactory('md5', 'test realm')
 
-        challenge = credentialFactory.getChallenge(clientAddress)
+        challenge = (yield credentialFactory.getChallenge(clientAddress))
 
 
         key = '%s,%s,%s' % (challenge['nonce'],

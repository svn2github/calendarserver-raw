Index: twisted/web2/dav/method/propfind.py
===================================================================
--- twisted/web2/dav/method/propfind.py	(revision 18545)
+++ twisted/web2/dav/method/propfind.py	(working copy)
@@ -22,6 +22,8 @@
 #
 # DRI: Wilfredo Sanchez, wsanchez@apple.com
 ##
+from twisted.web2.dav.util import joinURL
+import urllib
 
 """
 WebDAV PROPFIND method
@@ -114,79 +116,205 @@
     yield filtered_aces
     filtered_aces = filtered_aces.getResult()
 
-    resources = [(self, my_url)]
+    resources = [my_url.rstrip("/")]
 
-    d = self.findChildren(depth, request, lambda x, y: resources.append((x, y)), (davxml.Read(),), inherited_aces=filtered_aces)
-    x = waitForDeferred(d)
-    yield x
-    x.getResult()
+#    d = self.findChildrenBatch(depth, request, lambda x, y: resources.append((x, y)), (davxml.Read(),), inherited_aces=filtered_aces)
+#    x = waitForDeferred(d)
+#    yield x
+#    x.getResult()
+    if depth == "1":
+        d = self.findChildNames(request, lambda x: resources.append(joinURL(request.uri, x)), privileges=(davxml.Read(),), inherited_aces=filtered_aces)
+        x = waitForDeferred(d)
+        yield x
+        x.getResult()
 
-    for resource, uri in resources:
-        if search_properties is "names":
-            try:
-                resource_properties = waitForDeferred(resource.listProperties(request))
-                yield resource_properties
-                resource_properties = resource_properties.getResult()
-            except:
-                log.err("Unable to get properties for resource %r" % (resource,))
-                raise
+    if search_properties is "names":
+        results = {}
+        results[request.uri] = self.deadProperties().list()
+        
+        if depth == "1":
+            allowed_uris = set(resources)
+            child_results = self.deadProperties().listAll()
+            for key, value in child_results.iteritems():
+                uri = joinURL(request.uri, key)
+                if uri in allowed_uris:
+                    results[uri] = value
 
+        uris = results.keys()
+        uris.sort()
+        for uri in uris:
             properties_by_status = {
-                responsecode.OK: [propertyName(p) for p in resource_properties]
+                responsecode.OK: [propertyName(p) for p in results[uri]]
             }
-        else:
+            propstats = []
+    
+            for status in properties_by_status:
+                properties = properties_by_status[status]
+                if not properties: continue
+    
+                xml_status    = davxml.Status.fromResponseCode(status)
+                xml_container = davxml.PropertyContainer(*properties)
+                xml_propstat  = davxml.PropertyStatus(xml_container, xml_status)
+    
+                propstats.append(xml_propstat)
+    
+            xml_resource = davxml.HRef(uri)
+            if propstats:
+                xml_response = davxml.PropertyStatusResponse(xml_resource, *propstats)
+            else:
+                xml_response = davxml.StatusResponse(xml_resource, davxml.Status.fromResponseCode(responsecode.OK))
+    
+            xml_responses.append(xml_response)
+
+    elif search_properties is "all":
+        results = {}
+        results[request.uri] = self.deadProperties().getAll(nohidden=True)
+        
+        if depth == "1":
+            allowed_uris = set(resources)
+            child_results = self.deadProperties().getAllResources(nohidden=True)
+            for key, value in child_results.iteritems():
+                uri = joinURL(request.uri, key)
+                if uri in allowed_uris:
+                    results[uri] = value
+
+        uris = results.keys()
+        uris.sort()
+        for uri in uris:
             properties_by_status = {
+                responsecode.OK: [p for p in results[uri].itervalues()]
+            }
+            propstats = []
+    
+            for status in properties_by_status:
+                properties = properties_by_status[status]
+                if not properties: continue
+    
+                xml_status    = davxml.Status.fromResponseCode(status)
+                xml_container = davxml.PropertyContainer(*properties)
+                xml_propstat  = davxml.PropertyStatus(xml_container, xml_status)
+    
+                propstats.append(xml_propstat)
+    
+            xml_resource = davxml.HRef(uri)
+            if propstats:
+                xml_response = davxml.PropertyStatusResponse(xml_resource, *propstats)
+            else:
+                xml_response = davxml.StatusResponse(xml_resource, davxml.Status.fromResponseCode(responsecode.OK))
+    
+            xml_responses.append(xml_response)
+    
+    else:
+        results = {}
+        results[request.uri] = self.deadProperties().getSeveral(search_properties)
+        
+        if depth == "1":
+            allowed_uris = set(resources)
+            child_results = self.deadProperties().getSeveralResources(search_properties)
+            for key, value in child_results.iteritems():
+                uri = joinURL(request.uri, key)
+                if uri in allowed_uris:
+                    results[uri] = value
+
+        uris = results.keys()
+        uris.sort()
+        for uri in uris:
+            properties_by_status = {
                 responsecode.OK        : [],
                 responsecode.NOT_FOUND : [],
             }
+            for prop in search_properties:
+                if results[uri].has_key(prop):
+                    properties_by_status[responsecode.OK].append(results[uri][prop])
+                else:
+                    properties_by_status[responsecode.NOT_FOUND].append(propertyName(prop))
 
-            if search_properties is "all":
-                properties_to_enumerate = waitForDeferred(resource.listAllprop(request))
-                yield properties_to_enumerate
-                properties_to_enumerate = properties_to_enumerate.getResult()
+            propstats = []
+    
+            for status in properties_by_status:
+                properties = properties_by_status[status]
+                if not properties: continue
+    
+                xml_status    = davxml.Status.fromResponseCode(status)
+                xml_container = davxml.PropertyContainer(*properties)
+                xml_propstat  = davxml.PropertyStatus(xml_container, xml_status)
+    
+                propstats.append(xml_propstat)
+    
+            xml_resource = davxml.HRef(uri)
+            if propstats:
+                xml_response = davxml.PropertyStatusResponse(xml_resource, *propstats)
             else:
-                properties_to_enumerate = search_properties
+                xml_response = davxml.StatusResponse(xml_resource, davxml.Status.fromResponseCode(responsecode.OK))
+    
+            xml_responses.append(xml_response)
+    
+#    for resource, uri in resources:
+#        if search_properties is "names":
+#            try:
+#                resource_properties = waitForDeferred(resource.listProperties(request))
+#                yield resource_properties
+#                resource_properties = resource_properties.getResult()
+#            except:
+#                log.err("Unable to get properties for resource %r" % (resource,))
+#                raise
+#
+#            properties_by_status = {
+#                responsecode.OK: [propertyName(p) for p in resource_properties]
+#            }
+#        else:
+#            properties_by_status = {
+#                responsecode.OK        : [],
+#                responsecode.NOT_FOUND : [],
+#            }
+#
+#            if search_properties is "all":
+#                properties_to_enumerate = waitForDeferred(resource.listAllprop(request))
+#                yield properties_to_enumerate
+#                properties_to_enumerate = properties_to_enumerate.getResult()
+#            else:
+#                properties_to_enumerate = search_properties
+#
+#            for property in properties_to_enumerate:
+#                has = waitForDeferred(resource.hasProperty(property, request))
+#                yield has
+#                has = has.getResult()
+#                if has:
+#                    try:
+#                        resource_property = waitForDeferred(resource.readProperty(property, request))
+#                        yield resource_property
+#                        resource_property = resource_property.getResult()
+#                    except:
+#                        f = Failure()
+#
+#                        log.err("Error reading property %r for resource %s: %s" % (property, uri, f.value))
+#
+#                        status = statusForFailure(f, "getting property: %s" % (property,))
+#                        if status not in properties_by_status:
+#                            properties_by_status[status] = []
+#                        properties_by_status[status].append(propertyName(property))
+#                    else:
+#                        properties_by_status[responsecode.OK].append(resource_property)
+#                else:
+#                    properties_by_status[responsecode.NOT_FOUND].append(propertyName(property))
+#
+#        propstats = []
+#
+#        for status in properties_by_status:
+#            properties = properties_by_status[status]
+#            if not properties: continue
+#
+#            xml_status    = davxml.Status.fromResponseCode(status)
+#            xml_container = davxml.PropertyContainer(*properties)
+#            xml_propstat  = davxml.PropertyStatus(xml_container, xml_status)
+#
+#            propstats.append(xml_propstat)
+#
+#        xml_resource = davxml.HRef(uri)
+#        xml_response = davxml.PropertyStatusResponse(xml_resource, *propstats)
+#
+#        xml_responses.append(xml_response)
 
-            for property in properties_to_enumerate:
-                has = waitForDeferred(resource.hasProperty(property, request))
-                yield has
-                has = has.getResult()
-                if has:
-                    try:
-                        resource_property = waitForDeferred(resource.readProperty(property, request))
-                        yield resource_property
-                        resource_property = resource_property.getResult()
-                    except:
-                        f = Failure()
-
-                        log.err("Error reading property %r for resource %s: %s" % (property, uri, f.value))
-
-                        status = statusForFailure(f, "getting property: %s" % (property,))
-                        if status not in properties_by_status:
-                            properties_by_status[status] = []
-                        properties_by_status[status].append(propertyName(property))
-                    else:
-                        properties_by_status[responsecode.OK].append(resource_property)
-                else:
-                    properties_by_status[responsecode.NOT_FOUND].append(propertyName(property))
-
-        propstats = []
-
-        for status in properties_by_status:
-            properties = properties_by_status[status]
-            if not properties: continue
-
-            xml_status    = davxml.Status.fromResponseCode(status)
-            xml_container = davxml.PropertyContainer(*properties)
-            xml_propstat  = davxml.PropertyStatus(xml_container, xml_status)
-
-            propstats.append(xml_propstat)
-
-        xml_resource = davxml.HRef(uri)
-        xml_response = davxml.PropertyStatusResponse(xml_resource, *propstats)
-
-        xml_responses.append(xml_response)
-
     #
     # Return response
     #
